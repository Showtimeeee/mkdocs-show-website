# Гайд по Pytest

<div><img src="https://raw.githubusercontent.com/syvixor/skills-icons/8faa958456a73918dab7406acb8c2826d3cf67b6/icons/pytest.svg" title="pytest"  alt="pytest" />&nbsp;
</div>

Pytest — это фреймворк для тестирования на Python, который позволяет писать простые и масштабируемые тесты. Он поддерживает все стандартные утверждения Python и предлагает множество расширений для улучшения функциональности. Pytest широко используется в сообществе Python благодаря своей простоте и мощным возможностям.

Если вы хотите улучшить процесс тестирования ваших приложений, Pytest станет вашим надежным помощником.

## 1. **Основные концепции Pytest**

Перед тем как начать работу с Pytest, важно понять его ключевые компоненты:

- **Тестовые функции**: Функции, которые начинаются с префикса `test_` и содержат утверждения.
- **Утверждения (Assertions)**: Проверки, которые определяют, прошел ли тест успешно.
- **Фикстуры (Fixtures)**: Вспомогательные функции, которые настраивают окружение для тестов.
- **Параметризация (Parametrization)**: Возможность запуска одного теста с различными наборами данных.
- **Плагины (Plugins)**: Расширения, которые добавляют дополнительные функции в Pytest.

## 2. **Установка Pytest**

Для начала работы вам нужно установить Pytest. Это можно сделать с помощью pip:

```bash
pip install pytest
```

Проверьте установку:

```bash
pytest --version
```

## 3. **Написание первого теста**

Создайте файл `test_sample.py` и добавьте в него следующий код:

```python
def test_addition():
    assert 1 + 1 == 2

def test_subtraction():
    assert 2 - 1 == 1
```

Запустите тесты:

```bash
pytest test_sample.py
```

## 4. **Использование фикстур**

Фикстуры позволяют настраивать окружение для тестов. Вот пример использования фикстур:

```python
import pytest

@pytest.fixture
def sample_data():
    return {"key": "value"}

def test_sample_data(sample_data):
    assert sample_data["key"] == "value"
```

### 4.1. **Скоупы фикстур (области видимости)**

Фикстуры могут иметь разные области видимости (скоупы), которые определяют, как часто фикстура будет вызываться:

| Скоуп       | Описание                                                                 |
|-------------|--------------------------------------------------------------------------|
| **function** (по умолчанию) | Фикстура вызывается для каждой тестовой функции.                         |
| **class**   | Фикстура вызывается один раз для всех тестовых методов в классе.         |
| **module**  | Фикстура вызывается один раз для всех тестов в модуле.                   |
| **package** | Фикстура вызывается один раз для всех тестов в пакете.                   |
| **session** | Фикстура вызывается один раз для всей сессии тестирования.               |

Примеры:

```python
# Фикстура на уровне модуля
@pytest.fixture(scope="module")
def db_connection():
    print("Установка соединения с БД")
    yield "db_conn"
    print("Закрытие соединения с БД")

# Фикстура на уровне класса
@pytest.fixture(scope="class")
def setup_class():
    print("\nНастройка перед классом")
    yield
    print("\nОчистка после класса")

# Фикстура на уровне сессии
@pytest.fixture(scope="session")
def global_config():
    return {"env": "test", "timeout": 30}
```

**Когда использовать разные скоупы:**
- `function`: Для изолированных тестов, где нужно свежее состояние для каждого теста.
- `class`: Когда несколько тестовых методов используют одни и те же данные.
- `module`: Для тяжелых ресурсов (например, подключение к БД), которые можно переиспользовать.
- `session`: Для глобальных настроек (конфиги, аутентификация).

## 5. **Жизненный цикл ошибки в Pytest**

Когда тест падает, Pytest проходит через несколько этапов обработки ошибки:

1. **Обнаружение ошибки**: 
   - Во время выполнения теста возникает исключение (AssertionError или другое).
   
2. **Сбор информации**:
   - Pytest собирает трассировку стека (traceback).
   - Захватывает значение переменных в момент ошибки (если используется `-v` или `--tb=auto`).
   - Применяет фильтры к traceback для упрощения отладки.

3. **Обработка фикстур**:
   - Если тест использовал фикстуры с `yield`, выполняется код после `yield` (теardown).
   - Фикстуры закрываются в обратном порядке их создания.

4. **Формирование отчета**:
   - Ошибка классифицируется (AssertionError, Exception и т.д.).
   - Формируется сообщение об ошибке с контекстом.
   - Если используются плагины (например, pytest-html), ошибка добавляется в отчет.

5. **Продолжение выполнения**:
   - По умолчанию Pytest продолжает выполнять другие тесты после ошибки.
   - Можно изменить поведение через флаги (`-x` для остановки при первой ошибке).

**Пример жизненного цикла:**

```python
@pytest.fixture
def resource():
    print("\nСоздание ресурса")
    yield "ресурс"
    print("\nОчистка ресурса")  # Выполнится даже при ошибке в тесте

def test_failing(resource):
    assert False, "Искусственная ошибка"
```

Вывод:
```
Создание ресурса
F
Очистка ресурса
=================================== FAILURES ===================================
_______________________________ test_failing __________________________________

resource = 'ресурс'

    def test_failing(resource):
>       assert False, "Искусственная ошибка"
E       AssertionError: Искусственная ошибка
E       assert False

test_sample.py:6: AssertionError
```

## 6. **Параметризация тестов**

Параметризация позволяет запускать один тест с различными наборами данных. Вот пример:

```python
@pytest.mark.parametrize("input,expected", [
    (1, 2),
    (2, 3),
    (3, 4),
])
def test_increment(input, expected):
    assert input + 1 == expected
```

## 7. **Использование плагинов**

Pytest поддерживает множество плагинов, которые расширяют его функциональность. Вот несколько популярных плагинов:

- **pytest-xdist**: Параллельное выполнение тестов.
- **pytest-cov**: Измерение покрытия кода.
- **pytest-mock**: Мокирование объектов.
- **pytest-html**: Генерация HTML-отчетов.

Установка плагина:

```bash
pip install pytest-xdist
```

Использование плагина:

```bash
pytest -n 4  # Запуск тестов в 4 потока
```

## 8. **Советы по оптимизации**

- **Используйте фикстуры**: Для настройки окружения и очистки ресурсов.
- **Параметризуйте тесты**: Для уменьшения дублирования кода.
- **Используйте плагины**: Для расширения функциональности Pytest.
- **Пишите чистые тесты**: Следуйте принципам чистого кода и тестирования.
- **Анализируйте ошибки**: Используйте `pytest --pdb` для отладки в момент ошибки.

