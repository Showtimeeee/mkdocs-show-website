# Гайд по Apache Kafka: ключевые концепции

<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Apache_kafka_wordtype.svg/640px-Apache_kafka_wordtype.svg.png" title="Kafka" alt="Kafka" width="500" height="500" />

Apache Kafka — распределённый брокер сообщений для обработки потоковых данных в реальном времени. Широко используется в микросервисных архитектурах, event-driven системах и Big Data. В этом гайде разберём ключевые концепции Kafka и популярные вопросы на собеседованиях.

---

## **1. Основные концепции Kafka**

### **1.1. Архитектура Kafka**
- **Брокер (Broker)** — сервер, хранящий данные и обрабатывающий запросы.
- **Топик (Topic)** — логический канал для сообщений (аналог таблицы в БД).
- **Партиция (Partition)** — часть топика, обеспечивающая параллельную обработку.
- **Producer** — приложение, отправляющее сообщения в топик.
- **Consumer** — приложение, читающее сообщения из топика.
- **Consumer Group** — группа потребителей, совместно обрабатывающих данные.
- **ZooKeeper** (до Kafka 3.0+) — сервис для координации брокеров (в новых версиях заменён на KRaft).

### **1.2. Зачем нужен Kafka?**
- **Высокая пропускная способность** (миллионы сообщений в секунду).
- **Отказоустойчивость** (репликация данных между брокерами).
- **Горизонтальное масштабирование** (можно добавлять брокеры и партиции).
- **Поддержка потоковой обработки** (Kafka Streams, Flink, Spark).

---

## **2. Глубокое погружение в партиции и репликацию**

### **2.1. Партиции**
- Каждый топик делится на **партиции** (например, `orders-topic` может иметь 3 партиции: `P0`, `P1`, `P2`).
- **Порядок сообщений гарантируется только в пределах одной партиции**.
- **Ключ сообщения (Key)** определяет, в какую партицию оно попадёт:
  ```java
  // Если key=null, сообщения распределяются по round-robin
  producer.send(new ProducerRecord<>("orders", "order123", "{...}"));
  ```

### **2.2. Репликация**
- Каждая партиция имеет **реплики** (обычно 3: 1 лидер + 2 follower).
- **Лидер (Leader)** обрабатывает запросы, **фолловеры (Followers)** синхронизируются с ним.
- **ISR (In-Sync Replicas)** — реплики, актуальные на текущий момент.

> **Что происходит, если лидер падает?**  
> Контроллер (один из брокеров) выбирает нового лидера из ISR.

---

## **3. Consumer Groups и обработка сообщений**

### **3.1. Как работают Consumer Groups**
- **Один Consumer Group = один логический подписчик**.
- Сообщения **распределяются между Consumer'ами в группе** (по партициям).
- Каждый Consumer читает **только свою партицию** (если Consumer'ов больше, чем партиций — часть будет без работы).

### **3.2. Офсеты (Offsets)**
- **Офсет** — номер сообщения в партиции (например, `P0: offset=152`).
- **Consumer сам управляет офсетом** (может коммитить вручную или автоматически).
- **__consumer_offsets** — внутренний топик Kafka, хранящий офсеты.

> **Что такое `auto.offset.reset`?**  
> Политика при отсутствии офсета:  
> - `earliest` — читать с начала топика.  
> - `latest` — читать только новые сообщения.  

---

## **4. Настройка Producer и гарантии доставки**

### **4.1. Важные параметры Producer**
| Параметр | Описание |
|----------|----------|
| `acks=all` | Ждёт подтверждения от всех реплик (наибольшая надёжность). |
| `retries=3` | Число попыток повторной отправки при ошибке. |
| `linger.ms=100` | Задержка перед отправкой (увеличивает batch-размер). |
| `compression.type=snappy` | Сжатие сообщений (уменьшает трафик). |

### **4.2. Гарантии доставки**
- **At least once** (минимум 1 раз) — сообщение может быть доставлено повторно.
- **At most once** (максимум 1 раз) — возможна потеря сообщений.
- **Exactly once** (ровно 1 раз) — сложная настройка (требует `enable.idempotence=true`).

---

## **5. Вопросы на собеседовании**

### **5.1. Базовые вопросы**
1. **Чем Kafka отличается от RabbitMQ?**  
   - Kafka — для высоконагруженных потоков, RabbitMQ — для очередей задач.
   - Kafka хранит сообщения долго, RabbitMQ удаляет после доставки.

2. **Как Kafka обеспечивает отказоустойчивость?**  
   Через репликацию партиций и перевыбор лидера.

3. **Что такое Consumer Lag?**  
   Разница между последним сообщением в партиции и текущим офсетом Consumer'а.

### **5.2. Продвинутые вопросы**
4. **Как работает compaction топиков?**  
   Удаляет старые версии сообщений с одинаковым ключом.

5. **Что такое Kafka Connect и Kafka Streams?**  
   - **Kafka Connect** — инструмент для интеграции с внешними системами (БД, S3).  
   - **Kafka Streams** — библиотека для потоковой обработки.

6. **Как увеличить пропускную способность Kafka?**  
   - Добавить партиции.  
   - Настроить `linger.ms` и `batch.size` у Producer.  
   - Использовать сжатие (`compression.type`).  

---

## **6. Практические примеры**
### **6.1. Запуск Kafka локально (Docker)**
```bash
docker run -d --name zookeeper -p 2181:2181 zookeeper
docker run -d --name kafka -p 9092:9092 --link zookeeper \
  -e KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181 \
  -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 \
  -e KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1 \
  confluentinc/cp-kafka
```

### **6.2. Пример Producer на Python**
```python
from kafka import KafkaProducer

producer = KafkaProducer(
    bootstrap_servers="localhost:9092",
    value_serializer=lambda v: v.encode("utf-8"),
)

producer.send("test-topic", value="Hello, Kafka!")
producer.flush()
```